<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Piquizz – Style Wii</title>

<style>
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(#f4f9ff, #c2d4e6);
        color: #333;
        display: flex;
        flex-direction: column;
        cursor: none !important;
    }

    .container {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    /* TIMER */
    #timer {
        margin: 2rem auto 1rem auto;
        width: 18rem;
        height: 18rem;
        border-radius: 50%;
        background: white;
        border: 0.4rem solid #bcd0e0;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 4rem;
        font-weight: bold;
        color: #4a6fa5;
        box-shadow: 0 0.4rem 1rem rgba(0,0,0,0.15);
        transition: background 0.3s;
    }

    /* QUESTION */
    #question {
        margin: 0 auto;
        padding: 1.5rem;
        width: 80%;
        height: 11rem;
        font-size: 2.5rem;
        background: white;
        border-radius: 2rem;
        box-shadow: 0 0.4rem 1rem rgba(0,0,0,0.15);
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    /* BUZZERS */
    .buzzers {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 3rem;
        flex-wrap: wrap;
    }
    .buzzer {
        width: 16rem;
        height: 14rem;
        border-radius: 2rem;
        background: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2.2rem;
        font-weight: bold;
        color: #333;
        cursor: pointer;
        box-shadow: 0 0.6rem 1.5rem rgba(0,0,0,0.2);
        transition: transform 0.2s, box-shadow 0.2s;
        border: 1rem solid transparent;
    }
    .buzzer:hover {
        transform: scale(1.08);
        box-shadow: 0 1rem 2.5rem rgba(0,0,0,0.25);
    }
    .red { border-color: #ff6b6b; }
    .green { border-color: #6bcf8b; }
    .blue { border-color: #6bb5ff; }
    .white { border-color: #cccccc; }
    .yellow { border-color: #ffe28a; }

    @keyframes wiiBounce {
        0%   { transform: scale(1); }
        30%  { transform: scale(1.15); }
        60%  { transform: scale(0.95); }
        100% { transform: scale(1); }
    }

    .bounce {
        animation: wiiBounce 0.4s ease-out;
    }
    @keyframes wiiBlink {
        0%   { opacity: 1; }
        50%  { opacity: 0.3; }
        100% { opacity: 1; }
    }

    .winner {
        animation: wiiBlink 0.8s ease-in-out infinite;
    }
    @keyframes chronoSpin {
    from { transform: rotate(0deg); }
    to   { transform: rotate(360deg); }
}

/* Pulsation Wii */
@keyframes wiiPulse {
    0%   { transform: scale(1); }
    50%  { transform: scale(1.15); background: #ffb3b3; }
    100% { transform: scale(1); }
}

.timer-end {
    animation: wiiPulse 0.6s ease-out 3;
}


</style>
</head>

<body>

<div class="container">

    <div id="timer" onclick="restartTimer()">20</div>

    <div id="question"><%= question.categorie%> :<br><br><%= question.question%></div>

    <div class="buzzers">
        <div class="buzzer red" onclick="buzz(0)" id="j1"><%= players[0]%></div>
        <div class="buzzer green" onclick="buzz(1)" id="j2"><%= players[1]%></div>
        <div class="buzzer blue" onclick="buzz(2)" id="j3"><%= players[2]%></div>
        <div class="buzzer white" onclick="buzz(3)" id="j4"><%= players[3]%></div>
        <div class="buzzer yellow" onclick="buzz(4)" id="j5"><%= players[4]%></div>
    </div>

</div>



<script>

let players = ["<%=players[0] %>","<%=players[1] %>","<%=players[2] %>","<%=players[3] %>","<%=players[4] %>"];

const socket = new WebSocket("ws://piquizz.local:3000");

let timersec = 20;
let timeLeft = timersec;
let timerInterval = null;

const timerDiv = document.getElementById("timer");

// ----------------------
// Réception WebSocket
// ----------------------
socket.onmessage = (event) => {
    const msg = event.data;
    console.log("WS reçu :", msg);

    // WINNER:2
    if (msg.startsWith("WINNER:")) {
        const val = parseInt(msg.split(":")[1]);
        if (!isNaN(val)) buzz(val - 1);
        return;
    }

    // QUESTION:{...}
    if (msg.startsWith("QUESTION:")) {
        const json = msg.substring(9);
        const data = JSON.parse(json);

        document.getElementById("question").innerHTML =
            data.categorie + " : <br><br>" + data.question;

        resetBuzzersAnimations();
        stopTimer();
        timerDiv.style.background = "#ffffff";
        timeLeft = timersec;
        timerDiv.textContent = timeLeft;
        return;
    }

    // PLAYERS:[...]
    if (msg.startsWith("PLAYERS:")) {
        players = JSON.parse(msg.substring(8));
        changeName();
        return;
    }

    // USERQ:[...]
    if (msg.startsWith("USERQ:")) {
        // si tu veux les afficher
        return;
    }

    // RESTART
    if (msg === "RESTART") {
        resetBuzzersAnimations();
        startTimer();
        return;
    }

    // RESTART_TIMER
    if (msg === "RESTART_TIMER") {
        restartTimer();
        return;
    }

    // TIMER:xx
    if (msg.startsWith("TIMER:")) {
        console.log("Timer reçu :", msg);
        return;
    }
};

// ----------------------
// Envoi WebSocket
// ----------------------
function send(msg) {
    if (socket.readyState === WebSocket.OPEN) {
        socket.send(msg);
    }
}

// ----------------------
// Fonctions existantes
// ----------------------

function changeName(){
    document.getElementById("j1").innerHTML = players[0];
    document.getElementById("j2").innerHTML = players[1];
    document.getElementById("j3").innerHTML = players[2];
    document.getElementById("j4").innerHTML = players[3];
    document.getElementById("j5").innerHTML = players[4];
}

function buzz(playerIndex) {
    const buzzers = document.querySelectorAll(".buzzer");
    const buzzer = buzzers[playerIndex];
    stopTimer();

    buzzer.classList.remove("bounce");
    void buzzer.offsetWidth;
    buzzer.classList.add("bounce");

    setWinner(playerIndex);
}

function resetBuzzersAnimations() {
    const buzzers = document.querySelectorAll(".buzzer");
    buzzers.forEach(b => {
        b.classList.remove("bounce");
        b.classList.remove("winner");
        b.classList.remove("active");
    });
}

function setWinner(playerIndex) {
    const buzzers = document.querySelectorAll(".buzzer");
    buzzers.forEach(b => b.classList.remove("winner"));
    buzzers[playerIndex].classList.add("winner");
}

function restartTimer() {
    resetBuzzersAnimations();
    startTimer();
}

function stopTimer() {
    if (timerInterval !== null) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
}

function startTimer() {
    timerDiv.textContent = timeLeft;

    timerInterval = setInterval(() => {
        timeLeft--;
        timerDiv.textContent = timeLeft;

        send("TIMER:" + timeLeft);

        if (timeLeft <= 0) {
            stopTimer();
            timerDiv.textContent = "FIN";
            timerDiv.style.background = "#ffb3b3";
        }
    }, 1000);
}

</script>


</body>
</html>